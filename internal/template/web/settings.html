<header>
    <h1><iconify-icon icon="mdi:cog" class="icon-large icon-warning"></iconify-icon>{{call .T "settings.title"}}</h1>
</header>

<div class="grid grid-2">
    <section class="glass-card card">
        <h2 class="section-title"><iconify-icon icon="mdi:shield-lock" class="icon-danger"></iconify-icon>{{call .T "settings.security"}}</h2>
        <form>
            <div class="form-group">
                <label for="jwt_secret">{{call .T "settings.jwt_secret"}}</label>
                <input type="password" id="jwt_secret" placeholder="Current secret is hidden" disabled>
                <small>JWT secret is configured via environment variables</small>
            </div>
        </form>
    </section>
    
    <section class="glass-card card">
        <h2 class="section-title"><iconify-icon icon="mdi:calendar-clock" class="icon-info"></iconify-icon>{{call .T "settings.sync_schedule"}}</h2>
        <form id="sync-schedule-form">
            <div class="form-group">
                <label for="sync_interval">{{call .T "settings.sync_interval"}}</label>
                <select id="sync_interval">
                    <option value="5">{{call .T "time.minutes" 5}}</option>
                    <option value="15">{{call .T "time.minutes" 15}}</option>
                    <option value="30">{{call .T "time.minutes" 30}}</option>
                    <option value="60" selected>{{call .T "time.hour"}}</option>
                    <option value="120">{{call .T "time.hours" 2}}</option>
                    <option value="360">{{call .T "time.hours" 6}}</option>
                    <option value="720">{{call .T "time.hours" 12}}</option>
                    <option value="1440">{{call .T "time.hours" 24}}</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary">{{call .T "settings.update_schedule"}}</button>
        </form>
        
        <!-- 添加手动同步功能 -->
        <div style="margin-top: 1.5rem;">
            <h3><iconify-icon icon="mdi:sync" class="icon-info"></iconify-icon>{{call .T "storage.sync_now"}}</h3>
            <button id="manual-sync-btn" class="btn btn-primary">
                <iconify-icon icon="mdi:sync"></iconify-icon>{{call .T "storage.sync_now"}}
            </button>
            <div id="sync-result" style="margin-top: 1rem;"></div>
        </div>
    </section>
    
    <section class="glass-card card">
        <h2 class="section-title"><iconify-icon icon="mdi:database-cog" class="icon-purple"></iconify-icon>{{call .T "settings.database"}}</h2>
        <p><strong>{{call .T "common.type"}}:</strong> SQLite</p>
        <p><strong>{{call .T "common.location"}}:</strong> ./data/syncer.db</p>
        <p><strong>{{call .T "common.size"}}:</strong> 2.1 MB</p>
        <div class="button-group">
            <button class="btn btn-outline">{{call .T "settings.backup_database"}}</button>
            <button class="btn btn-danger" id="resetDatabaseBtn">{{call .T "settings.reset_database"}}</button>
        </div>
        <small class="help-text">
            {{call .T "settings.reset_database_help"}}
        </small>
    </section>
    
    <section class="glass-card card">
        <h2 class="section-title"><iconify-icon icon="mdi:folder-open" class="icon-warning"></iconify-icon>{{call .T "settings.vaultwarden_data"}}</h2>
        <form id="vaultwarden-data-form">
            <div class="form-group">
                <label for="vaultwarden_data_path">{{call .T "settings.vaultwarden_data_path"}}</label>
                <input type="text" id="vaultwarden_data_path" placeholder="/vw-data" value="/vw-data">
                <small>{{call .T "settings.vaultwarden_data_help"}}</small>
            </div>
            <button type="submit" class="btn btn-primary">{{call .T "settings.update_path"}}</button>
        </form>
    </section>
</div>

<!-- 手动同步弹出框 -->
<div id="sync-modal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>{{call .T "storage.select_storage"}}</h3>
            <button class="modal-close" onclick="closeSyncModal()">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>{{call .T "storage.select_storage"}}</label>
                <select id="sync-storage-select" multiple size="5" style="width: 100%;">
                    <option value="0">{{call .T "storage.all_enabled"}}</option>
                </select>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-outline" onclick="closeSyncModal()">{{call .T "common.cancel"}}</button>
            <button class="btn btn-primary" onclick="triggerManualSync()">{{call .T "common.sync"}}</button>
        </div>
    </div>
</div>

<script>
// Handle vaultwarden data path form
function handleVaultwardenDataForm() {
    const form = document.getElementById('vaultwarden-data-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const path = document.getElementById('vaultwarden_data_path').value;
            // TODO: Implement vaultwarden data path update functionality
            alert('Vaultwarden data path update functionality not implemented yet. Path: ' + path);
        });
    }
}

// Load storage options for manual sync
function loadStorageOptions() {
    fetch('/api/storages')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('sync-storage-select');
            // Clear existing options except "all"
            select.innerHTML = '<option value="0">{{call .T "storage.all_enabled"}}</option>';
            
            // Add storage options
            data.forEach(storage => {
                const option = document.createElement('option');
                option.value = storage.id;
                option.textContent = storage.name + ' (' + storage.type.toUpperCase() + ')';
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Failed to load storage options:', error);
        });
}

// Open sync modal
function openSyncModal() {
    loadStorageOptions();
    document.getElementById('sync-modal').style.display = 'block';
}

// Close sync modal
function closeSyncModal() {
    document.getElementById('sync-modal').style.display = 'none';
}

// Trigger manual sync
function triggerManualSync() {
    const selectedOptions = Array.from(document.getElementById('sync-storage-select').selectedOptions);
    const selectedStorages = selectedOptions.map(option => parseInt(option.value));
    
    // Send request to trigger manual sync
    fetch('/api/sync-manual', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            storage_ids: selectedStorages
        })
    })
    .then(response => response.text())
    .then(html => {
        document.getElementById('sync-result').innerHTML = html;
        closeSyncModal();
    })
    .catch(error => {
        console.error('Failed to trigger manual sync:', error);
        document.getElementById('sync-result').innerHTML = 
            '<div class="result error">Failed to trigger manual sync</div>';
        closeSyncModal();
    });
}

// Add confirmation for reset database button
document.addEventListener('DOMContentLoaded', function() {
    handleVaultwardenDataForm();
    
    // Handle sync schedule form submission
    const scheduleForm = document.getElementById('sync-schedule-form');
    if (scheduleForm) {
        scheduleForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const interval = document.getElementById('sync_interval').value;
            // TODO: Implement schedule update functionality
            alert('Sync schedule update functionality not implemented yet. Interval: ' + interval + ' minutes');
        });
    }
    
    // Handle manual sync button
    const manualSyncBtn = document.getElementById('manual-sync-btn');
    if (manualSyncBtn) {
        manualSyncBtn.addEventListener('click', function(e) {
            e.preventDefault();
            openSyncModal();
        });
    }
    
    const resetBtn = document.getElementById('resetDatabaseBtn');
    if (resetBtn) {
        resetBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (confirm('{{call .T "settings.reset_database_confirm"}}')) {
                // TODO: Implement reset database functionality
                alert('{{call .T "settings.reset_database_not_implemented"}}');
            }
        });
    }
    
    // Close modal when clicking outside
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('sync-modal');
        if (event.target === modal) {
            closeSyncModal();
        }
    });
});
</script>