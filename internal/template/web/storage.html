<div class="page-header">
    <h1>{{call .T "storage.title"}}</h1>
    <p>{{call .T "storage.manage_subtitle"}}</p>
</div>

<div class="main-content">
    <section class="add-storage-section">
        <h2>{{call .T "storage.add_new"}}</h2>
        <p>{{call .T "storage.add_new_description"}}</p>
        
        <form id="storage-form" hx-post="/api/storage" hx-target="#result">
            <div>
                <label for="storage_name">{{call .T "storage.name"}}:</label>
                <input type="text" id="storage_name" name="name" placeholder="{{call .T "storage.name_placeholder"}}" required>
            </div>
            <div>
                <label for="storage_type">{{call .T "common.type"}}:</label>
                <select id="storage_type" name="type" required>
                    <option value="">{{call .T "storage.select_type"}}</option>
                    <option value="webdav">WebDAV</option>
                    <option value="s3">S3</option>
                </select>
            </div>
            
            <!-- WebDAV specific fields -->
            <div id="webdav-fields" class="storage-config storage-type-fields" style="display: none;">
                <div class="form-group">
                    <label for="webdav_url">{{call .T "storage.webdav.url"}}</label>
                    <input type="url" id="webdav_url" name="webdav_url" placeholder="{{call .T "storage.webdav.url_placeholder"}}" class="form-input">
                </div>
                <div class="form-group">
                    <label for="webdav_username">{{call .T "auth.username"}}</label>
                    <input type="text" id="webdav_username" name="webdav_username" placeholder="{{call .T "auth.username"}}" class="form-input">
                </div>
                <div class="form-group">
                    <label for="webdav_password">{{call .T "auth.password"}}</label>
                    <input type="password" id="webdav_password" name="webdav_password" placeholder="{{call .T "auth.password"}}" class="form-input">
                </div>
            </div>

            <!-- S3 specific fields -->
            <div id="s3-fields" class="storage-config storage-type-fields" style="display: none;">
                <div class="form-group">
                    <label for="s3_endpoint">{{call .T "storage.s3.endpoint"}} <span class="optional">({{call .T "storage.optional"}})</span></label>
                    <input type="text" id="s3_endpoint" name="s3_endpoint" placeholder="{{call .T "storage.s3.endpoint_placeholder"}}" class="form-input">
                    <small class="form-hint">{{call .T "storage.s3.endpoint_hint"}}</small>
                </div>
                <div class="form-group">
                    <label for="s3_access_key_id">{{call .T "storage.s3.access_key_id"}}</label>
                    <input type="text" id="s3_access_key_id" name="s3_access_key_id" placeholder="{{call .T "storage.s3.access_key_id"}}" class="form-input">
                </div>
                <div class="form-group">
                    <label for="s3_secret_access_key">{{call .T "storage.s3.secret_access_key"}}</label>
                    <input type="password" id="s3_secret_access_key" name="s3_secret_access_key" placeholder="{{call .T "storage.s3.secret_access_key"}}" class="form-input">
                </div>
                <div class="form-group">
                    <label for="s3_region">{{call .T "storage.s3.region"}}</label>
                    <input type="text" id="s3_region" name="s3_region" placeholder="{{call .T "storage.s3.region_placeholder"}}" class="form-input">
                </div>
                <div class="form-group">
                    <label for="s3_bucket">{{call .T "storage.s3.bucket"}}</label>
                    <input type="text" id="s3_bucket" name="s3_bucket" placeholder="{{call .T "storage.s3.bucket_placeholder"}}" class="form-input">
                </div>
            </div>

            <div class="form-group checkbox-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="storage_enabled" name="enabled">
                    {{call .T "storage.enable_immediately"}}
                </label>
            </div>

            <button type="submit" class="btn btn-primary">{{call .T "storage.add_backend"}}</button>
        </form>
    </section>
    
    <section class="storage-list-section">
        <h2>{{call .T "storage.your_backends"}}</h2>
        <div id="storage-list">
            {{.StorageCards}}
        </div>
    </section>
</div>

<div id="result" class="result" style="display: none;"></div>

<script>
console.log('Storage template JavaScript loaded');

document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM content loaded for storage page');
    
    const form = document.getElementById('storage-form');
    const result = document.getElementById('result');
    const typeSelect = document.getElementById('storage_type');
    const webdavFields = document.getElementById('webdav-fields');
    const s3Fields = document.getElementById('s3-fields');

    function setRequired(el, required) {
        if (!el) return;
        if (required) {
            el.setAttribute('required', 'required');
        } else {
            el.removeAttribute('required');
        }
    }

    function updateTypeFields() {
        if (webdavFields) webdavFields.style.display = 'none';
        if (s3Fields) s3Fields.style.display = 'none';

        setRequired(document.getElementById('webdav_url'), false);
        setRequired(document.getElementById('webdav_username'), false);
        setRequired(document.getElementById('webdav_password'), false);
        setRequired(document.getElementById('s3_access_key_id'), false);
        setRequired(document.getElementById('s3_secret_access_key'), false);
        setRequired(document.getElementById('s3_region'), false);
        setRequired(document.getElementById('s3_bucket'), false);

        const val = typeSelect ? typeSelect.value : '';
        if (val === 'webdav') {
            if (webdavFields) webdavFields.style.display = 'block';
            setRequired(document.getElementById('webdav_url'), true);
            setRequired(document.getElementById('webdav_username'), true);
            setRequired(document.getElementById('webdav_password'), true);
        } else if (val === 's3') {
            if (s3Fields) s3Fields.style.display = 'block';
            setRequired(document.getElementById('s3_access_key_id'), true);
            setRequired(document.getElementById('s3_secret_access_key'), true);
            setRequired(document.getElementById('s3_region'), true);
            setRequired(document.getElementById('s3_bucket'), true);
        }
    }

    if (typeSelect) {
        typeSelect.addEventListener('change', updateTypeFields);
        updateTypeFields();
    }

    if (form) {
        form.addEventListener('submit', function(e) {
            // Client-side basic validation is already handled by required attributes
        });
    }
});
</script>
