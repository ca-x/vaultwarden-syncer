# 路由流程说明

## 系统默认路由逻辑

系统现在实现了智能的默认跳转逻辑，确保用户始终被引导到正确的页面。

### 🔄 路由流程

#### 1. 访问根路径 `/`
- **第一步**: 认证中间件检查系统是否已初始化
  - ❌ 如果**未初始化** → 自动跳转到 `/setup`
  - ✅ 如果**已初始化** → 继续检查认证状态

- **第二步**: 检查用户认证状态
  - ❌ 如果**未认证** → 跳转到 `/login`
  - ✅ 如果**已认证** → 显示仪表板

#### 2. 访问登录页面 `/login`
- **检查系统初始化状态**
  - ❌ 如果**未初始化** → 跳转到 `/setup`
  - ✅ 如果**已初始化** → 显示登录表单

#### 3. 访问设置页面 `/setup`
- **检查系统初始化状态**
  - ✅ 如果**已初始化** → 跳转到 `/`
  - ❌ 如果**未初始化** → 显示设置向导

### 📊 路由决策表

| 用户访问路径 | 系统状态 | 认证状态 | 最终页面 |
|-------------|----------|----------|----------|
| `/` | 未初始化 | - | `/setup` |
| `/` | 已初始化 | 未认证 | `/login` |
| `/` | 已初始化 | 已认证 | 仪表板 |
| `/login` | 未初始化 | - | `/setup` |
| `/login` | 已初始化 | - | 登录表单 |
| `/setup` | 未初始化 | - | 设置向导 |
| `/setup` | 已初始化 | - | `/` |

### 🛡️ 认证中间件逻辑

认证中间件 `RequireAuth()` 现在包含以下检查顺序：

1. **系统初始化检查**
   ```go
   setupComplete, err := m.setupService.IsSetupComplete(ctx)
   if !setupComplete {
       return c.Redirect(http.StatusFound, "/setup")
   }
   ```

2. **JWT Token 验证**
   ```go
   // 从 Authorization header 或 Cookie 获取 token
   // 验证 token 有效性
   // 设置用户上下文信息
   ```

### 🔐 受保护的路由

以下路由需要通过认证中间件：
- `/` - 仪表板
- `/logout` - 注销
- `/storage` - 存储管理
- `/api/storage/*` - 存储 API
- `/api/sync/*` - 同步 API
- `/api/jobs` - 同步任务 API

### 🌐 公共路由

以下路由无需认证：
- `/health` - 健康检查
- `/setup` - 系统设置
- `/api/setup` - 设置 API
- `/login` - 登录页面
- `/api/login` - 登录 API

### 🎯 用户体验优化

1. **首次访问**: 未初始化的用户直接被引导到设置页面
2. **重复访问**: 已初始化但未登录的用户被引导到登录页面
3. **已登录用户**: 直接显示仪表板，无需额外跳转
4. **智能重定向**: 所有路径都会检查前置条件，确保用户总是在正确的页面

### 🔧 技术实现

- **中间件级别检查**: 在认证中间件中统一处理初始化状态检查
- **避免循环重定向**: 每个页面都有明确的前置条件检查
- **单一职责**: 每个 handler 专注于自己的核心功能
- **统一入口**: 所有保护的路由都通过同一个认证中间件